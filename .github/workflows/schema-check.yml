name: Schema Check

on:
  pull_request:
    paths:
      - 'backend/infrastructure/database/schema/**'
      - 'backend/atlas.hcl'
      - 'backend/domains/*/internal/po/**'

jobs:
  schema-lint:
    name: Atlas Schema Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Atlas
        run: |
          curl -sSf https://atlasgo.sh | sh
          sudo mv atlas /usr/local/bin/
      
      - name: Validate schema
        working-directory: ./backend
        run: |
          chmod +x scripts/schema.sh
          ./scripts/schema.sh validate
      
      - name: Lint schema
        working-directory: ./backend
        run: |
          ./scripts/schema.sh lint
      
      - name: Check for schema changes
        id: schema_changes
        working-directory: ./backend
        run: |
          # æ£€æŸ¥ schema æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --name-only origin/main...HEAD | grep -q "infrastructure/database/schema"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Schema files have changes"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          fi
      
      - name: Generate migration preview
        if: steps.schema_changes.outputs.has_changes == 'true'
        working-directory: ./backend
        env:
          ATLAS_ENV: test
        run: |
          echo "## Migration Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following changes will be applied:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```sql' >> $GITHUB_STEP_SUMMARY
          
          # ç”Ÿæˆ diffï¼ˆä»…é¢„è§ˆï¼Œä¸å®é™…åˆ›å»ºè¿ç§»ï¼‰
          atlas schema diff \
            --from "docker://postgres/15/test" \
            --to "file://infrastructure/database/schema" \
            --dev-url "docker://postgres/15/dev" || echo "No changes or error occurred"
          
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR
        if: steps.schema_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ—„ï¸ Schema Changes Detected\n\n' +
                    'Please review the schema changes carefully:\n\n' +
                    '1. Check the migration preview in the workflow summary\n' +
                    '2. Ensure backward compatibility if needed\n' +
                    '3. Consider data migration requirements\n' +
                    '4. Update seed data if necessary\n\n' +
                    '**Reminder**: After merging, run `./scripts/schema.sh diff <name>` to generate the migration.'
            })

  schema-compatibility:
    name: Check Schema Compatibility
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: go_genai_stack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout base branch
        run: |
          git fetch origin main
          git checkout origin/main
      
      - name: Install Atlas
        run: |
          curl -sSf https://atlasgo.sh | sh
          sudo mv atlas /usr/local/bin/
      
      - name: Apply base schema
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/go_genai_stack_test?sslmode=disable
          ATLAS_ENV: test
        run: |
          chmod +x scripts/schema.sh
          # åº”ç”¨åŸºçº¿ schema
          atlas schema apply \
            --url "$DATABASE_URL" \
            --to "file://infrastructure/database/schema" \
            --dev-url "docker://postgres/15/dev" \
            --auto-approve
      
      - name: Checkout PR branch
        run: |
          git checkout ${{ github.head_ref }}
      
      - name: Test schema migration
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/go_genai_stack_test?sslmode=disable
          ATLAS_ENV: test
        run: |
          # å°è¯•åº”ç”¨ PR ä¸­çš„ schema å˜æ›´
          atlas schema apply \
            --url "$DATABASE_URL" \
            --to "file://infrastructure/database/schema" \
            --dev-url "docker://postgres/15/dev" \
            --auto-approve
          
          echo "âœ… Schema migration successful - no breaking changes detected"
      
      - name: Verify data integrity
        run: |
          # æ£€æŸ¥æ•°æ®åº“è¿æ¥å’ŒåŸºæœ¬æŸ¥è¯¢
          psql postgresql://postgres:postgres@localhost:5432/go_genai_stack_test?sslmode=disable -c "SELECT 1"
          
          echo "âœ… Database is accessible and healthy"

