name: Coverage Report

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥ä¾¿å¯¹æ¯”
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: backend/go.sum
    
    - name: Install dependencies
      working-directory: backend
      run: go mod download
    
    - name: Run tests with coverage
      working-directory: backend
      run: |
        # ä¸ºæ¯ä¸ªåŒ…ç”Ÿæˆè¦†ç›–ç‡
        go test -v -coverprofile=coverage.out -covermode=atomic ./...
        
        # ç”Ÿæˆ HTML æŠ¥å‘Š
        go tool cover -html=coverage.out -o coverage.html
        
        # ç”Ÿæˆè¯¦ç»†çš„æ–‡æœ¬æŠ¥å‘Š
        go tool cover -func=coverage.out -o coverage-detail.txt
    
    - name: Generate coverage badge
      working-directory: backend
      run: |
        # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "COVERAGE=${coverage}" >> $GITHUB_ENV
        
        # æ ¹æ®è¦†ç›–ç‡ç”Ÿæˆé¢œè‰²
        if (( $(echo "$coverage >= 90" | bc -l) )); then
          color="brightgreen"
        elif (( $(echo "$coverage >= 80" | bc -l) )); then
          color="green"
        elif (( $(echo "$coverage >= 70" | bc -l) )); then
          color="yellowgreen"
        elif (( $(echo "$coverage >= 60" | bc -l) )); then
          color="yellow"
        else
          color="red"
        fi
        echo "COVERAGE_COLOR=${color}" >> $GITHUB_ENV
    
    - name: Create coverage report comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = process.env.COVERAGE;
          const coverageDetail = fs.readFileSync('backend/coverage-detail.txt', 'utf8');
          
          // è§£æè¯¦ç»†è¦†ç›–ç‡
          const lines = coverageDetail.split('\n').filter(line => line.trim());
          const packages = lines.slice(0, -1).map(line => {
            const parts = line.split(/\s+/);
            return {
              package: parts[0],
              coverage: parts[1]
            };
          });
          
          // ç”Ÿæˆ Markdown è¡¨æ ¼
          let table = '| Package | Coverage |\n|---------|----------|\n';
          packages.forEach(pkg => {
            const emoji = parseFloat(pkg.coverage) >= 80 ? 'âœ…' : 'âš ï¸';
            table += `| ${pkg.package} | ${emoji} ${pkg.coverage} |\n`;
          });
          
          const body = `## ğŸ“Š Coverage Report
          
          **Total Coverage: ${coverage}%**
          
          ${table}
          
          ### è¦†ç›–ç‡æ ‡å‡†
          - âœ… â‰¥ 80%: è‰¯å¥½
          - âš ï¸ < 80%: éœ€è¦æ”¹è¿›
          
          ### è¯¦ç»†æŠ¥å‘Š
          æŸ¥çœ‹ [è¦†ç›–ç‡è¯¦æƒ…](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;
          
          // æŸ¥æ‰¾ç°æœ‰è¯„è®º
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.data.find(
            comment => comment.user.login === 'github-actions[bot]' && comment.body.includes('Coverage Report')
          );
          
          if (existingComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: body
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          backend/coverage.out
          backend/coverage.html
          backend/coverage-detail.txt
        retention-days: 90
    
    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: backend/coverage.out
        flags: unittests
        name: backend-coverage
        fail_ci_if_error: true
        verbose: true

