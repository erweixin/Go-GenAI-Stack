# Database Makefile
# ç®€åŒ–çš„æ•°æ®åº“ç®¡ç†å‘½ä»¤

.PHONY: help status diff apply seed clean lint validate inspect init hash clean-docker seed-docker

# é»˜è®¤ç¯å¢ƒ
ENV ?= dev

# ç¯å¢ƒå˜é‡æ–‡ä»¶è·¯å¾„
ENV_FILE := ../../docker/.env

# Shell é…ç½®ï¼šè‡ªåŠ¨åŠ è½½ç¯å¢ƒå˜é‡
SHELL := /bin/bash
.SHELLFLAGS := -c

# å®šä¹‰åŠ è½½ç¯å¢ƒå˜é‡çš„å‡½æ•°
define load_env
	@if [ -f "$(ENV_FILE)" ]; then \
		set -a; source $(ENV_FILE); set +a; \
	fi
endef

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ğŸ“š æ•°æ®åº“ç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "åŸºç¡€å‘½ä»¤ï¼š"
	@echo "  make init          - åˆ›å»ºåˆå§‹è¿ç§»ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰"
	@echo "  make status        - æŸ¥çœ‹è¿ç§»çŠ¶æ€"
	@echo "  make diff          - ç”Ÿæˆæ–°è¿ç§»ï¼ˆéœ€è¦ NAME=xxxï¼‰"
	@echo "  make apply         - åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“"
	@echo "  make seed          - åŠ è½½ç§å­æ•°æ®ï¼ˆéœ€è¦ psqlï¼‰"
	@echo "  make seed-docker   - åŠ è½½ç§å­æ•°æ®ï¼ˆä½¿ç”¨ Dockerï¼‰"
	@echo ""
	@echo "å·¥å…·å‘½ä»¤ï¼š"
	@echo "  make inspect       - æŸ¥çœ‹å½“å‰æ•°æ®åº“ç»“æ„"
	@echo "  make hash          - ç”Ÿæˆè¿ç§»æ ¡éªŒå’Œ"
	@echo "  make lint          - æ£€æŸ¥è¿ç§»è´¨é‡"
	@echo "  make validate      - éªŒè¯è¿ç§»æ–‡ä»¶"
	@echo "  make clean         - æ¸…ç©ºæ•°æ®åº“ï¼ˆå±é™©ï¼éœ€è¦ psqlï¼‰"
	@echo "  make clean-docker  - æ¸…ç©ºæ•°æ®åº“ï¼ˆä½¿ç”¨ Dockerï¼‰"
	@echo ""
	@echo "ç¤ºä¾‹ï¼š"
	@echo "  make init                       # é¦–æ¬¡åˆ›å»ºåˆå§‹è¿ç§»"
	@echo "  make apply                      # åº”ç”¨è¿ç§»"
	@echo "  make seed-docker                # åŠ è½½æ¼”ç¤ºæ•°æ®"
	@echo "  make diff NAME=add_new_field    # ç”Ÿæˆæ–°è¿ç§»"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡ï¼š"
	@echo "  ENV=dev (é»˜è®¤) | prod           # è®¾ç½®ç¯å¢ƒ"
	@echo ""
	@echo "ğŸ’¡ æç¤ºï¼š"
	@echo "   ç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä» ../../docker/.env åŠ è½½"
	@echo "   ç¡®ä¿è¯¥æ–‡ä»¶å­˜åœ¨å¹¶åŒ…å«æ­£ç¡®çš„é…ç½®"

init: ## åˆ›å»ºåˆå§‹è¿ç§»ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
	@echo "ğŸš€ åˆ›å»ºåˆå§‹è¿ç§»..."
	@if [ -n "$$(ls -A migrations 2>/dev/null)" ]; then \
		echo "âŒ é”™è¯¯ï¼šmigrations/ ç›®å½•ä¸ä¸ºç©º"; \
		echo "   å¦‚æœè¦é‡æ–°åˆå§‹åŒ–ï¼Œè¯·å…ˆåˆ é™¤ migrations/ ç›®å½•"; \
		exit 1; \
	fi
	@mkdir -p migrations
	@TIMESTAMP=$$(date +%Y%m%d%H%M%S); \
	cp schema.sql migrations/$${TIMESTAMP}_initial_schema.sql && \
	echo "âœ… åˆå§‹è¿ç§»å·²åˆ›å»º: migrations/$${TIMESTAMP}_initial_schema.sql"
	@$(MAKE) hash
	@echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ 'make apply' åº”ç”¨è¿ç§»"

hash: ## ç”Ÿæˆè¿ç§»æ ¡éªŒå’Œ
	@echo "ğŸ” ç”Ÿæˆæ ¡éªŒå’Œ..."
	@atlas migrate hash --env $(ENV)
	@echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆ"

status: ## æŸ¥çœ‹è¿ç§»çŠ¶æ€
	@echo "ğŸ“Š è¿ç§»çŠ¶æ€..."
	atlas migrate status --env $(ENV)

diff: ## ç”Ÿæˆæ–°è¿ç§»ï¼ˆéœ€è¦ NAME=xxxï¼‰
ifndef NAME
	@echo "âŒ é”™è¯¯ï¼šè¯·æŒ‡å®šè¿ç§»åç§°"
	@echo "   make diff NAME=add_new_field"
	@exit 1
endif
	@echo "ğŸ” ç”Ÿæˆè¿ç§»: $(NAME)..."
	atlas migrate diff $(NAME) --env $(ENV)
	@echo "âœ… è¿ç§»å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ migrations/ ç›®å½•"

apply: ## åº”ç”¨è¿ç§»
	@echo "âš ï¸  å°†è¦åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“"
	@echo ""
	@atlas migrate status --env $(ENV) || true
	@echo ""
	@read -p "ç¡®è®¤åº”ç”¨ï¼Ÿ(y/N) " confirm && [ "$$confirm" = "y" ] || exit 1
	atlas migrate apply --env $(ENV)
	@echo "âœ… è¿ç§»å·²åº”ç”¨"

seed: ## åŠ è½½ç§å­æ•°æ®ï¼ˆéœ€è¦ psqlï¼‰
	@echo "ğŸŒ± åŠ è½½ç§å­æ•°æ®..."
	@if [ -z "$$POSTGRES_USER" ]; then \
		echo "âŒ é”™è¯¯ï¼šè¯·å…ˆåŠ è½½ç¯å¢ƒå˜é‡"; \
		echo "   source ../../docker/.env"; \
		exit 1; \
	fi
	@for file in seed/*.sql; do \
		if [ -f "$$file" ]; then \
			echo "ğŸ“ åŠ è½½: $$(basename $$file)"; \
			psql "postgresql://$$POSTGRES_USER:$$POSTGRES_PASSWORD@$$POSTGRES_HOST:$$POSTGRES_PORT/$$POSTGRES_DB" -f "$$file"; \
		fi \
	done
	@echo "âœ… ç§å­æ•°æ®å·²åŠ è½½"

seed-docker: ## åŠ è½½ç§å­æ•°æ®ï¼ˆä½¿ç”¨ Dockerï¼‰
	@echo "ğŸŒ± åŠ è½½ç§å­æ•°æ®ï¼ˆä½¿ç”¨ Dockerï¼‰..."
	@if [ -f "$(ENV_FILE)" ]; then \
		set -a; source $(ENV_FILE); set +a; \
		for file in seed/*.sql; do \
			if [ -f "$$file" ]; then \
				echo "ğŸ“ åŠ è½½: $$(basename $$file)"; \
				docker exec -i go-genai-postgres psql -U $$POSTGRES_USER -d $$POSTGRES_DB < "$$file"; \
			fi; \
		done; \
		echo "âœ… ç§å­æ•°æ®å·²åŠ è½½"; \
	else \
		echo "âŒ é”™è¯¯ï¼š$(ENV_FILE) ä¸å­˜åœ¨"; \
		exit 1; \
	fi

inspect: ## æŸ¥çœ‹å½“å‰æ•°æ®åº“ç»“æ„
	@echo "ğŸ” æ•°æ®åº“ç»“æ„..."
	atlas schema inspect --env $(ENV) --format "{{ sql . }}"

lint: ## æ£€æŸ¥è¿ç§»è´¨é‡
	@echo "ğŸ” æ£€æŸ¥è¿ç§»è´¨é‡..."
	atlas migrate lint --env $(ENV) --latest 1

validate: ## éªŒè¯è¿ç§»æ–‡ä»¶
	@echo "âœ… éªŒè¯è¿ç§»æ–‡ä»¶..."
	atlas migrate validate --env $(ENV)

clean: ## æ¸…ç©ºæ•°æ®åº“ï¼ˆå±é™©ï¼éœ€è¦ psqlï¼‰
	@echo "âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰è¡¨å’Œæ•°æ®ï¼"
	@read -p "ç¡®è®¤æ¸…ç©ºæ•°æ®åº“ï¼Ÿè¾“å…¥ 'yes' ç»§ç»­: " confirm && [ "$$confirm" = "yes" ] || exit 1
	@echo "ğŸ—‘ï¸  æ¸…ç©ºæ•°æ®åº“..."
	@if [ -z "$$POSTGRES_USER" ]; then \
		echo "âŒ é”™è¯¯ï¼šè¯·å…ˆåŠ è½½ç¯å¢ƒå˜é‡"; \
		exit 1; \
	fi
	psql "postgresql://$$POSTGRES_USER:$$POSTGRES_PASSWORD@$$POSTGRES_HOST:$$POSTGRES_PORT/$$POSTGRES_DB" \
		-c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
	@echo "âœ… æ•°æ®åº“å·²æ¸…ç©º"
	@echo "ğŸ’¡ è¿è¡Œ 'make apply' é‡æ–°åˆ›å»ºè¡¨"

clean-docker: ## æ¸…ç©ºæ•°æ®åº“ï¼ˆä½¿ç”¨ Dockerï¼‰
	@echo "âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰è¡¨å’Œæ•°æ®ï¼"
	@read -p "ç¡®è®¤æ¸…ç©ºæ•°æ®åº“ï¼Ÿè¾“å…¥ 'yes' ç»§ç»­: " confirm && [ "$$confirm" = "yes" ] || exit 1
	@echo "ğŸ—‘ï¸  æ¸…ç©ºæ•°æ®åº“..."
	@if [ -f "$(ENV_FILE)" ]; then \
		set -a; source $(ENV_FILE); set +a; \
		docker exec -i go-genai-postgres psql -U $$POSTGRES_USER -d $$POSTGRES_DB \
			-c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"; \
		echo "âœ… æ•°æ®åº“å·²æ¸…ç©º"; \
		echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š"; \
		echo "   1. åˆ é™¤æ—§è¿ç§»: rm -rf migrations && mkdir migrations"; \
		echo "   2. åˆ›å»ºåˆå§‹è¿ç§»: make init"; \
		echo "   3. åº”ç”¨è¿ç§»: make apply"; \
	else \
		echo "âŒ é”™è¯¯ï¼š$(ENV_FILE) ä¸å­˜åœ¨"; \
		exit 1; \
	fi

