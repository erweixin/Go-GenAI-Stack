.PHONY: help build lint lint-fix test test-coverage fmt vet staticcheck tools clean

# é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Go-GenAI-Stack Backend Makefile"
	@echo ""
	@echo "Usage:"
	@echo "  make build         - Build the application"
	@echo "  make lint          - Run all lint checks"
	@echo "  make lint-fix      - Auto-fix lint issues"
	@echo "  make test          - Run all tests"
	@echo "  make test-coverage - Run tests with coverage"
	@echo "  make fmt           - Format code"
	@echo "  make vet           - Run go vet"
	@echo "  make staticcheck   - Run staticcheck"
	@echo "  make tools         - Install development tools"
	@echo "  make check         - Run all checks (build + lint + test)"
	@echo "  make clean         - Clean build artifacts"

# å®‰è£…å¼€å‘å·¥å…·
tools:
	@echo "ğŸ”§ Installing development tools..."
	@go install golang.org/x/tools/cmd/goimports@latest
	@go install honnef.co/go/tools/cmd/staticcheck@latest
	@go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest
	@echo "âœ… Tools installed"

# æ„å»ºåº”ç”¨
build:
	@echo "ğŸ”¨ Building application..."
	@go build -v ./...
	@echo "âœ… Build successful"

# æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
build-binary:
	@echo "ğŸ”¨ Building binary..."
	@mkdir -p bin
	@go build -o bin/server ./cmd/server
	@echo "âœ… Binary created: bin/server"
	@ls -lh bin/

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "ğŸ“ Formatting code..."
	@gofmt -w .
	@if command -v goimports >/dev/null 2>&1; then \
		goimports -w .; \
	fi
	@echo "âœ… Code formatted"

# Go vet æ£€æŸ¥
vet:
	@echo "ğŸ” Running go vet..."
	@go vet ./...
	@echo "âœ… go vet passed"

# Staticcheck æ£€æŸ¥
staticcheck:
	@echo "ğŸ” Running staticcheck..."
	@if command -v staticcheck >/dev/null 2>&1; then \
		staticcheck ./...; \
	else \
		echo "âš ï¸  staticcheck not found, run 'make tools' first"; \
		exit 1; \
	fi
	@echo "âœ… staticcheck passed"

# Lint æ£€æŸ¥
lint: fmt vet staticcheck
	@echo "âœ… All lint checks passed"

# è‡ªåŠ¨ä¿®å¤ Lint é—®é¢˜
lint-fix:
	@echo "ğŸ”§ Auto-fixing lint issues..."
	@gofmt -w .
	@if command -v goimports >/dev/null 2>&1; then \
		goimports -w .; \
	fi
	@go mod tidy
	@echo "âœ… All fixes applied"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª Running tests..."
	@go test -v -race ./...
	@echo "âœ… Tests passed"

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
test-coverage:
	@echo "ğŸ§ª Running tests with coverage..."
	@go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
	@go tool cover -func=coverage.out | grep total
	@echo ""
	@echo "ğŸ“Š Coverage report generated: coverage.out"
	@echo "   View with: go tool cover -html=coverage.out"

# æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "ğŸ§¹ Cleaning..."
	@rm -rf bin/
	@rm -f coverage.out coverage-*.out
	@go clean
	@echo "âœ… Clean complete"

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥
check: build lint test
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… All checks passed!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
