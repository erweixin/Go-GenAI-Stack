.PHONY: help lint lint-fix test test-coverage fmt vet staticcheck tools

# é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Go-GenAI-Stack Backend Makefile"
	@echo ""
	@echo "Usage:"
	@echo "  make lint          - Run all lint checks"
	@echo "  make lint-fix      - Auto-fix lint issues"
	@echo "  make test          - Run all tests"
	@echo "  make test-coverage - Run tests with coverage"
	@echo "  make fmt           - Format code"
	@echo "  make vet           - Run go vet"
	@echo "  make staticcheck   - Run staticcheck"
	@echo "  make tools         - Install development tools"
	@echo "  make check         - Run all checks (lint + test)"

# å®‰è£…å¼€å‘å·¥å…·
tools:
	@echo "ğŸ”§ Installing development tools..."
	@go install golang.org/x/tools/cmd/goimports@latest
	@go install honnef.co/go/tools/cmd/staticcheck@latest
	@go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@latest
	@echo "âœ… Tools installed"

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "ğŸ“ Formatting code..."
	@gofmt -w .
	@if command -v goimports >/dev/null 2>&1; then \
		goimports -w .; \
	fi
	@echo "âœ… Code formatted"

# Go vet æ£€æŸ¥
vet:
	@echo "ğŸ” Running go vet..."
	@go vet ./...
	@echo "âœ… go vet passed"

# Staticcheck æ£€æŸ¥
staticcheck:
	@echo "ğŸ” Running staticcheck..."
	@if command -v staticcheck >/dev/null 2>&1; then \
		staticcheck ./...; \
	else \
		echo "âš ï¸  staticcheck not found, run 'make tools' first"; \
		exit 1; \
	fi
	@echo "âœ… staticcheck passed"

# Lint æ£€æŸ¥
lint: fmt vet staticcheck
	@echo "ğŸ” Running golangci-lint..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run --timeout=5m ./...; \
	else \
		echo "âš ï¸  golangci-lint not found"; \
		echo "Install with: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b \$$(go env GOPATH)/bin"; \
		exit 1; \
	fi
	@echo "âœ… All lint checks passed"

# è‡ªåŠ¨ä¿®å¤ Lint é—®é¢˜
lint-fix:
	@echo "ğŸ”§ Auto-fixing lint issues..."
	@gofmt -w .
	@if command -v goimports >/dev/null 2>&1; then \
		goimports -w .; \
	fi
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run --fix --timeout=5m ./...; \
	fi
	@go mod tidy
	@echo "âœ… All fixes applied"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª Running tests..."
	@go test -v -race ./...
	@echo "âœ… Tests passed"

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
test-coverage:
	@echo "ğŸ§ª Running tests with coverage..."
	@go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
	@go tool cover -func=coverage.out | grep total
	@echo ""
	@echo "ğŸ“Š Coverage report generated: coverage.out"
	@echo "   View with: go tool cover -html=coverage.out"

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥
check: lint test
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… All checks passed!"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

