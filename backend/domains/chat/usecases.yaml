# Chat Domain Use Cases
# 用例声明文件 - AI 可读，用于自动生成 Handler 代码

version: "1.0"
domain: chat

usecases:
  # ========================================
  # 用例 1: 发送消息
  # ========================================
  SendMessage:
    description: "用户发送消息给 AI 并获得回复"
    sensitivity: medium
    http:
      method: POST
      path: /api/chat/send
    
    input:
      user_id:
        type: string
        required: true
        description: "用户 ID"
      message:
        type: string
        required: true
        validation: "max=10000,min=1"
        description: "消息内容"
      model:
        type: string
        required: false
        default: "gpt-4o"
        description: "使用的模型"
      conversation_id:
        type: string
        required: false
        description: "对话 ID，如果为空则创建新对话"
    
    output:
      message_id:
        type: string
        description: "AI 回复的消息 ID"
      content:
        type: string
        description: "AI 回复内容"
      tokens:
        type: int
        description: "消耗的 token 数量"
      conversation_id:
        type: string
        description: "对话 ID"
      model:
        type: string
        description: "实际使用的模型"
    
    steps:
      - name: ValidateInput
        type: sync
        description: "验证输入参数"
        on_fail: abort
        
      - name: CheckRateLimit
        type: sync
        description: "检查用户限流"
        on_fail: abort
        error: RATE_LIMIT_EXCEEDED
        
      - name: GetOrCreateConversation
        type: sync
        description: "获取或创建对话"
        on_fail: abort
        
      - name: SaveUserMessage
        type: sync
        description: "保存用户消息"
        on_fail: abort
        
      - name: PublishMessageSentEvent
        type: event
        event_type: MessageSent
        description: "发布消息发送事件"
        
      - name: CallLLM
        type: external
        adapter: llmService.Generate
        description: "调用 LLM 生成回复"
        timeout: 30s
        on_fail: retry
        retry_policy:
          max_attempts: 3
          backoff: exponential
        
      - name: SaveAssistantMessage
        type: sync
        description: "保存 AI 回复"
        on_fail: abort
        
      - name: PublishMessageReceivedEvent
        type: event
        event_type: MessageReceived
        description: "发布消息接收事件"
        
      - name: UpdateTokenUsage
        type: async
        description: "更新 token 使用统计"
        on_fail: log
    
    errors:
      - code: MESSAGE_EMPTY
        message: "消息不能为空"
        http_status: 400
      - code: MESSAGE_TOO_LONG
        message: "消息过长，最大 10000 字符"
        http_status: 400
      - code: RATE_LIMIT_EXCEEDED
        message: "请求过于频繁，请稍后再试"
        http_status: 429
      - code: CONVERSATION_NOT_FOUND
        message: "对话不存在"
        http_status: 404
      - code: LLM_ERROR
        message: "模型调用失败"
        http_status: 500

  # ========================================
  # 用例 2: 流式发送消息
  # ========================================
  StreamMessage:
    description: "流式发送消息并实时返回 AI 回复"
    sensitivity: medium
    http:
      method: POST
      path: /api/chat/stream
    
    input:
      user_id:
        type: string
        required: true
      message:
        type: string
        required: true
        validation: "max=10000,min=1"
      model:
        type: string
        required: false
        default: "gpt-4o"
      conversation_id:
        type: string
        required: false
    
    output:
      stream: true
      content_type: "text/event-stream"
      chunk_format: |
        data: {"content": "...", "done": false}
        
        data: {"content": "", "done": true, "message_id": "...", "tokens": 100}
    
    steps:
      - name: ValidateInput
        type: sync
        on_fail: abort
        
      - name: CheckRateLimit
        type: sync
        on_fail: abort
        
      - name: GetOrCreateConversation
        type: sync
        on_fail: abort
        
      - name: SaveUserMessage
        type: sync
        on_fail: abort
        
      - name: PublishStreamStartedEvent
        type: event
        event_type: StreamStarted
        
      - name: StreamFromLLM
        type: streaming
        adapter: llmService.Stream
        timeout: 5m
        on_fail: abort
        on_chunk: SendToClient
        
      - name: SaveAssistantMessage
        type: sync
        description: "保存完整的 AI 回复"
        on_fail: log
        
      - name: PublishStreamCompletedEvent
        type: event
        event_type: StreamCompleted
    
    errors:
      - code: STREAM_ERROR
        message: "流式传输失败"
        http_status: 500
      - code: CONNECTION_CLOSED
        message: "客户端连接已关闭"
        http_status: 499

  # ========================================
  # 用例 3: 获取对话历史
  # ========================================
  GetHistory:
    description: "获取指定对话的历史消息"
    sensitivity: low
    http:
      method: GET
      path: /api/chat/history/:conversation_id
    
    input:
      user_id:
        type: string
        required: true
        source: header
      conversation_id:
        type: string
        required: true
        source: path
      limit:
        type: int
        required: false
        default: 50
        validation: "max=100,min=1"
        source: query
      offset:
        type: int
        required: false
        default: 0
        source: query
    
    output:
      conversation_id:
        type: string
      title:
        type: string
      messages:
        type: array
        items:
          message_id: string
          role: string
          content: string
          tokens: int
          timestamp: string
      total_count:
        type: int
      has_more:
        type: bool
    
    steps:
      - name: ValidateAccess
        type: sync
        description: "验证用户是否有权访问该对话"
        on_fail: abort
        error: UNAUTHORIZED_ACCESS
        
      - name: GetConversation
        type: sync
        description: "获取对话元数据"
        on_fail: abort
        error: CONVERSATION_NOT_FOUND
        
      - name: GetMessages
        type: sync
        description: "分页获取消息列表"
        on_fail: abort
        
      - name: FormatResponse
        type: sync
        description: "格式化返回数据"
    
    errors:
      - code: CONVERSATION_NOT_FOUND
        message: "对话不存在"
        http_status: 404
      - code: UNAUTHORIZED_ACCESS
        message: "无权访问此对话"
        http_status: 403

  # ========================================
  # 用例 4: 创建对话
  # ========================================
  CreateConversation:
    description: "创建一个新的空对话"
    sensitivity: low
    http:
      method: POST
      path: /api/chat/conversations
    
    input:
      user_id:
        type: string
        required: true
      title:
        type: string
        required: false
        default: "新对话"
        validation: "max=100"
    
    output:
      conversation_id:
        type: string
      title:
        type: string
      created_at:
        type: string
    
    steps:
      - name: GenerateConversationID
        type: sync
        description: "生成唯一的对话 ID"
        
      - name: CreateConversationRecord
        type: sync
        description: "创建对话记录"
        on_fail: abort
        
      - name: PublishConversationCreatedEvent
        type: event
        event_type: ConversationCreated
    
    errors:
      - code: CREATION_FAILED
        message: "创建对话失败"
        http_status: 500

  # ========================================
  # 用例 5: 删除对话
  # ========================================
  DeleteConversation:
    description: "删除指定对话及其所有消息"
    sensitivity: high
    http:
      method: DELETE
      path: /api/chat/conversations/:conversation_id
    
    input:
      user_id:
        type: string
        required: true
        source: header
      conversation_id:
        type: string
        required: true
        source: path
    
    output:
      success:
        type: bool
      deleted_at:
        type: string
    
    steps:
      - name: ValidateOwnership
        type: sync
        description: "验证对话所有权"
        on_fail: abort
        error: UNAUTHORIZED_ACCESS
        
      - name: GetConversationStats
        type: sync
        description: "获取对话统计（用于事件）"
        on_fail: log
        
      - name: DeleteMessages
        type: sync
        description: "删除所有消息"
        on_fail: abort
        
      - name: DeleteConversation
        type: sync
        description: "删除对话记录"
        on_fail: abort
        
      - name: PublishConversationDeletedEvent
        type: event
        event_type: ConversationDeleted
        
      - name: CleanupCache
        type: async
        description: "清理缓存"
        on_fail: log
    
    errors:
      - code: CONVERSATION_NOT_FOUND
        message: "对话不存在"
        http_status: 404
      - code: UNAUTHORIZED_ACCESS
        message: "无权删除此对话"
        http_status: 403
      - code: DELETION_FAILED
        message: "删除失败"
        http_status: 500

  # ========================================
  # 用例 6: 获取对话列表
  # ========================================
  ListConversations:
    description: "获取用户的对话列表"
    sensitivity: low
    http:
      method: GET
      path: /api/chat/conversations
    
    input:
      user_id:
        type: string
        required: true
        source: header
      limit:
        type: int
        required: false
        default: 20
        validation: "max=50,min=1"
        source: query
      offset:
        type: int
        required: false
        default: 0
        source: query
    
    output:
      conversations:
        type: array
        items:
          conversation_id: string
          title: string
          last_message: string
          last_message_at: string
          message_count: int
          total_tokens: int
      total_count:
        type: int
      has_more:
        type: bool
    
    steps:
      - name: QueryConversations
        type: sync
        description: "分页查询对话列表"
        on_fail: abort
        
      - name: EnrichConversationData
        type: sync
        description: "补充对话统计信息"
        on_fail: log
        
      - name: FormatResponse
        type: sync
    
    errors:
      - code: QUERY_FAILED
        message: "查询失败"
        http_status: 500

# ========================================
# 全局配置
# ========================================
config:
  default_timeout: 30s
  max_retries: 3
  enable_tracing: true
  enable_metrics: true

# ========================================
# 依赖关系
# ========================================
dependencies:
  external:
    - name: llmService
      type: LLMDomain
      description: "LLM 领域服务"
      required: true
    - name: monitoringService
      type: MonitoringDomain
      description: "监控领域服务"
      required: false
  
  infrastructure:
    - name: database
      type: PostgreSQL
      description: "对话和消息存储"
    - name: cache
      type: Redis
      description: "缓存和限流"
    - name: eventBus
      type: Kafka
      description: "事件总线"

