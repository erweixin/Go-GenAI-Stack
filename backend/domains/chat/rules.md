# Chat Domain Rules (聊天领域业务规则)

## 消息规则

### R1: 消息内容验证
**规则**：消息内容不能为空，且不能超过最大长度限制。

**约束**：
- 最小长度：1 字符
- 最大长度：10,000 字符
- 编码：UTF-8

**错误码**：
- `MESSAGE_EMPTY` - 消息为空
- `MESSAGE_TOO_LONG` - 消息过长

**示例**：
```go
if len(strings.TrimSpace(message)) == 0 {
    return errors.New("MESSAGE_EMPTY")
}
if len(message) > 10000 {
    return errors.New("MESSAGE_TOO_LONG")
}
```

---

### R2: 消息角色限制
**规则**：消息的 Role 字段必须是 `user`, `assistant`, `system` 之一。

**约束**：
- 用户只能发送 `user` 角色的消息
- `assistant` 消息只能由系统生成
- `system` 消息用于系统提示词

**错误码**：`INVALID_ROLE`

---

### R3: 消息顺序约束
**规则**：对话中的消息必须按时间顺序排列。

**约束**：
- 新消息的 timestamp 必须大于上一条消息
- 不允许插入或修改历史消息（仅追加）

**例外**：
- 系统管理员可以编辑消息（用于审核）

---

## 对话规则

### R4: 对话所有权
**规则**：用户只能访问和操作自己的对话。

**约束**：
- 查询对话时必须验证 `UserID` 匹配
- 删除对话时必须验证所有权
- 分享对话需要明确授权

**错误码**：`UNAUTHORIZED_ACCESS`

**实现**：
```go
if conversation.UserID != currentUserID {
    return errors.New("UNAUTHORIZED_ACCESS")
}
```

---

### R5: 对话标题生成
**规则**：新建对话时，如果未指定标题，自动从首条消息生成。

**策略**：
- 取首条用户消息的前 30 个字符
- 如果包含换行，只取第一行
- 截断时添加 "..."

**示例**：
```
用户输入：
"请帮我写一个关于春天的诗歌，要求包含桃花、柳树和燕子三个意象..."

生成标题：
"请帮我写一个关于春天的诗歌，要求包含桃花..."
```

---

### R6: 对话删除策略
**规则**：删除对话时，级联删除所有相关数据。

**影响范围**：
- Conversation 记录
- 所有 Message 记录
- 对话统计数据
- 对话分享记录（如果有）

**不影响**：
- Token 使用统计（保留用于计费）
- 审计日志

---

## 上下文管理规则

### R7: Token 限制
**规则**：发送给 LLM 的上下文 Token 数不能超过模型限制。

**不同模型的限制**：
- GPT-4o: 128,000 tokens
- GPT-4o-mini: 128,000 tokens
- Claude 3.5 Sonnet: 200,000 tokens
- Gemini 1.5 Pro: 1,000,000 tokens

**处理策略**：
1. 优先保留最近的消息
2. 如果仍超限，截断早期消息
3. 始终保留首条 system 消息

**错误码**：`CONTEXT_TOO_LONG`

---

### R8: 历史消息截断
**规则**：当对话历史过长时，自动截断以适应 Token 限制。

**截断策略**：
1. **滑动窗口**（默认）：保留最近 N 条消息
2. **首尾保留**：保留首条 + 最近 N 条
3. **摘要压缩**：将旧消息摘要后作为单条 system 消息

**配置**：
```yaml
truncation:
  strategy: sliding_window
  max_messages: 20
  max_tokens: 100000
```

---

## 流式传输规则

### R9: 流式数据格式
**规则**：流式消息必须遵循 SSE (Server-Sent Events) 格式。

**格式要求**：
```
data: {"content": "Hello", "done": false}

data: {"content": " world", "done": false}

data: {"content": "", "done": true, "message_id": "msg-123", "tokens": 5}

```

**约束**：
- 每条数据以 `data: ` 开头
- 数据为 JSON 格式
- 最后一条消息标记 `done: true`

---

### R10: 流式连接超时
**规则**：流式连接必须在合理时间内完成或超时。

**超时配置**：
- 连接超时：30 秒
- 首字节超时：10 秒
- 总时长限制：5 分钟

**错误处理**：
- 超时后关闭连接
- 返回部分结果（如果有）
- 记录错误日志

---

## 限流和配额规则

### R11: 用户限流
**规则**：单个用户的请求频率受限制。

**限制**：
- 每分钟最多 60 次请求
- 每小时最多 1000 次请求
- 并发连接数最多 5 个

**错误码**：`RATE_LIMIT_EXCEEDED`

**实现**：Token Bucket 算法

---

### R12: 消息大小限制
**规则**：单条消息和单次请求的大小有限制。

**限制**：
- 单条消息：10,000 字符
- 单次请求 Body：1 MB
- 历史消息总数：最多返回 100 条

**错误码**：
- `MESSAGE_TOO_LONG`
- `PAYLOAD_TOO_LARGE`

---

## 安全规则

### R13: 内容过滤
**规则**：用户消息和 AI 回复都需要经过内容审核。

**过滤范围**：
- 违法违规内容
- 暴力、色情内容
- 个人隐私信息
- 恶意攻击内容

**处理方式**：
- 阻止发送（用户消息）
- 替换为警告（AI 回复）
- 记录审核日志

**错误码**：`MESSAGE_FILTERED`

---

### R14: 用户隔离
**规则**：不同用户的对话数据必须严格隔离。

**约束**：
- 查询时必须添加 `user_id` 过滤条件
- 禁止跨用户访问
- 数据库行级权限控制

**例外**：
- 系统管理员可以查看（审计目的）
- 需要完整的操作日志

---

## 性能规则

### R15: 响应时间要求
**规则**：API 响应时间应在合理范围内。

**目标**：
- 非流式接口：P95 < 2 秒
- 流式接口首字节：P95 < 1 秒
- 历史查询：P95 < 500ms

**降级策略**：
- 超时后返回部分结果
- 启用缓存
- 限制历史记录查询范围

---

### R16: 缓存策略
**规则**：频繁访问的数据应该被缓存。

**可缓存数据**：
- 用户最近的对话列表（5 分钟）
- 对话元数据（10 分钟）
- ~~消息内容~~（不缓存，保证实时性）

**缓存失效**：
- 新消息发送后清除对话缓存
- 对话删除后清除所有相关缓存

---

## 业务规则测试清单

每个规则都应该有对应的测试用例：

- [ ] R1: 消息内容验证
- [ ] R2: 消息角色限制
- [ ] R3: 消息顺序约束
- [ ] R4: 对话所有权
- [ ] R5: 对话标题生成
- [ ] R6: 对话删除策略
- [ ] R7: Token 限制
- [ ] R8: 历史消息截断
- [ ] R9: 流式数据格式
- [ ] R10: 流式连接超时
- [ ] R11: 用户限流
- [ ] R12: 消息大小限制
- [ ] R13: 内容过滤
- [ ] R14: 用户隔离
- [ ] R15: 响应时间要求
- [ ] R16: 缓存策略

---

## 规则优先级

**P0 - 安全规则**：R13, R14（必须强制执行）

**P1 - 核心业务规则**：R1, R2, R4, R7（影响核心功能）

**P2 - 性能和体验规则**：R8, R11, R15（影响用户体验）

**P3 - 优化规则**：R5, R16（锦上添花）

