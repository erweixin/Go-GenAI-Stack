# User Domain Use Cases
# 用户领域用例声明文件

version: "1.0"
domain: user

usecases:
  # ========================================
  # 用例 1: 获取用户信息
  # ========================================
  GetUserProfile:
    description: "获取当前用户的个人资料"
    sensitivity: medium
    http:
      method: GET
      path: /api/users/me
      auth_required: true
    
    input:
      user_id:
        type: string
        required: true
        source: context
        description: "用户 ID (from JWT)"
    
    output:
      user_id:
        type: string
        description: "用户 ID"
      email:
        type: string
        description: "邮箱"
      username:
        type: string
        description: "用户名"
      full_name:
        type: string
        description: "全名"
      avatar_url:
        type: string
        description: "头像 URL"
      created_at:
        type: string
        description: "创建时间"
      updated_at:
        type: string
        description: "更新时间"
    
    steps:
      - name: GetUserFromDB
        type: sync
        description: "从数据库获取用户信息"
        on_fail: abort
        error: USER_NOT_FOUND
      
      - name: FormatResponse
        type: sync
        description: "格式化响应数据"
    
    errors:
      - code: USER_NOT_FOUND
        message: "用户不存在"
        http_status: 404
      - code: QUERY_FAILED
        message: "查询失败"
        http_status: 500

  # ========================================
  # 用例 2: 更新用户资料
  # ========================================
  UpdateUserProfile:
    description: "更新用户的个人资料"
    sensitivity: medium
    http:
      method: PUT
      path: /api/users/me
      auth_required: true
    
    input:
      user_id:
        type: string
        required: true
        source: context
        description: "用户 ID (from JWT)"
      username:
        type: string
        required: false
        validation: "omitempty,min=3,max=30,alphanum"
        description: "用户名"
      full_name:
        type: string
        required: false
        validation: "omitempty,max=100"
        description: "全名"
      avatar_url:
        type: string
        required: false
        validation: "omitempty,url"
        description: "头像 URL"
    
    output:
      user_id:
        type: string
      username:
        type: string
      full_name:
        type: string
      avatar_url:
        type: string
      updated_at:
        type: string
    
    steps:
      - name: ValidateInput
        type: sync
        description: "验证输入参数"
        on_fail: abort
      
      - name: GetUser
        type: sync
        description: "获取用户"
        on_fail: abort
        error: USER_NOT_FOUND
      
      - name: CheckUsernameUnique
        type: sync
        description: "检查用户名是否已被占用"
        on_fail: abort
        error: USERNAME_ALREADY_EXISTS
      
      - name: UpdateUserFields
        type: sync
        description: "更新用户字段"
      
      - name: SaveUser
        type: sync
        description: "保存用户"
        on_fail: abort
      
      - name: PublishUserUpdatedEvent
        type: event
        event_type: UserUpdated
        on_fail: log
    
    errors:
      - code: USER_NOT_FOUND
        message: "用户不存在"
        http_status: 404
      - code: USERNAME_ALREADY_EXISTS
        message: "用户名已被占用"
        http_status: 400
      - code: INVALID_USERNAME
        message: "用户名格式无效（3-30 字符，仅字母数字）"
        http_status: 400
      - code: UPDATE_FAILED
        message: "更新失败"
        http_status: 500

  # ========================================
  # 用例 3: 修改密码
  # ========================================
  ChangePassword:
    description: "修改用户密码"
    sensitivity: high
    http:
      method: POST
      path: /api/users/me/change-password
      auth_required: true
    
    input:
      user_id:
        type: string
        required: true
        source: context
        description: "用户 ID (from JWT)"
      old_password:
        type: string
        required: true
        validation: "min=8"
        description: "旧密码"
      new_password:
        type: string
        required: true
        validation: "min=8,max=128"
        description: "新密码"
    
    output:
      success:
        type: bool
        description: "是否成功"
      message:
        type: string
        description: "提示消息"
    
    steps:
      - name: ValidateInput
        type: sync
        description: "验证输入"
        on_fail: abort
      
      - name: GetUser
        type: sync
        description: "获取用户"
        on_fail: abort
        error: USER_NOT_FOUND
      
      - name: VerifyOldPassword
        type: sync
        description: "验证旧密码"
        on_fail: abort
        error: INVALID_PASSWORD
      
      - name: HashNewPassword
        type: sync
        description: "哈希新密码"
      
      - name: UpdatePassword
        type: sync
        description: "更新密码"
        on_fail: abort
      
      - name: RevokeAllTokens
        type: sync
        description: "撤销所有 Token（可选）"
        on_fail: log
    
    errors:
      - code: USER_NOT_FOUND
        message: "用户不存在"
        http_status: 404
      - code: INVALID_PASSWORD
        message: "旧密码错误"
        http_status: 401
      - code: WEAK_PASSWORD
        message: "新密码强度不足（至少 8 字符）"
        http_status: 400
      - code: UPDATE_FAILED
        message: "修改密码失败"
        http_status: 500

# ========================================
# 全局配置
# ========================================
config:
  default_timeout: 30s
  enable_tracing: true
  enable_metrics: true

# ========================================
# 依赖关系
# ========================================
dependencies:
  external:
    - name: Auth Domain
      description: "用于密码验证和 Token 管理"
  
  infrastructure:
    - name: database
      type: PostgreSQL
      description: "用户数据存储"
    - name: cache
      type: Redis
      description: "用户缓存（可选）"
      required: false

