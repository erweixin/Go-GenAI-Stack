# Product Domain - Business Rules (业务规则)

本文档定义了商品领域的所有业务规则和约束条件。

---

## 1. 商品创建规则

### R1.1 商品名称规则
- ✅ **必填**：商品名称不能为空
- ✅ **长度限制**：1-200 个字符
- ✅ **唯一性**：同一商品名称可以重复（不强制唯一）

**错误码**：`PRODUCT_NAME_EMPTY`, `PRODUCT_NAME_TOO_LONG`

---

### R1.2 金币规则
- ✅ **必填**：初始金币数必须指定
- ✅ **正整数**：初始金币必须 > 0
- ✅ **金币类型**：必须是 `gold` 或 `silver`

**业务逻辑**：
- 免费商品（0 金币）需使用特殊类型（如 `free`，扩展功能）
- 金币数可以后续修改

**错误码**：`INVALID_COINS`, `INVALID_COIN_TYPE`

---

### R1.3 库存规则
- ✅ **非负数**：总库存必须 ≥ 0
- ✅ **默认值**：创建时可以设置初始库存
- ✅ **无限库存**：暂不支持（必须指定具体数量）

**错误码**：`INVALID_STOCK`

---

### R1.4 成本规则
- ✅ **可选字段**：成本可以为空
- ✅ **非负数**：如果设置成本，必须 ≥ 0
- ✅ **精度**：保留两位小数

**用途**：用于内部财务核算，不对用户展示。

**错误码**：`INVALID_COST`

---

### R1.5 限购规则
- ✅ **可选字段**：不设置表示不限购
- ✅ **正整数**：如果设置，必须 > 0
- ✅ **上限**：建议 ≤ 100（防止异常值）

**业务场景**：
- 限量商品：设置为 1 或 2
- 普通商品：不设置限制

**错误码**：`INVALID_PURCHASE_LIMIT`

---

## 2. 商品更新规则

### R2.1 更新限制
- ✅ **允许更新**：名称、描述、图片、成本、限购
- ✅ **谨慎更新**：初始金币（影响用户预期）
- ❌ **禁止更新**：已兑换数量（只能通过兑换流程增加）

**业务逻辑**：
- 已上架商品更新后立即生效
- 已下架商品可以自由更新

**错误码**：`UPDATE_FAILED`, `PRODUCT_NOT_FOUND`

---

### R2.2 库存更新规则
- ✅ **增加库存**：随时可以增加
- ✅ **减少库存**：
  - 必须 ≥ 已兑换数量
  - 必须 ≥ 当前上架数量
- ❌ **不能直接修改已兑换数量**：只能通过兑换流程自动增加

**公式验证**：
```
新总库存 >= 已兑换数量
新总库存 >= 上架数量
```

**错误码**：`INSUFFICIENT_STOCK`, `REDEEMED_COUNT_EXCEEDS_STOCK`

---

## 3. 上架规则

### R3.1 上架前置条件
- ✅ **状态检查**：当前状态必须是下架
- ✅ **库存检查**：总库存 > 0
- ✅ **库存充足**：上架数量 ≤ 可用库存

**可用库存计算**：
```
可用库存 = 总库存 - 已兑换数量
```

**错误码**：`ALREADY_ON_SHELF`, `INSUFFICIENT_STOCK_TO_SHELVE`

---

### R3.2 上架数量规则
- ✅ **必填**：上架时必须指定数量
- ✅ **正整数**：上架数量 > 0
- ✅ **不超过库存**：上架数量 ≤ 可用库存
- ✅ **限量上架**：如果设置了上架限量，不能超过限量

**业务场景**：
- 分批上架：总库存 1000，每次上架 100
- 全量上架：总库存 50，上架 50

**错误码**：`INVALID_SHELVE_QUANTITY`, `EXCEEDS_LISTED_LIMIT`

---

### R3.3 上架后状态
- ✅ **状态变更**：商品状态 → 上架
- ✅ **记录操作人**：更新 OperatorID
- ✅ **更新时间**：UpdatedAt 自动更新
- ✅ **发布事件**：ProductShelved

---

## 4. 下架规则

### R4.1 下架前置条件
- ✅ **状态检查**：当前状态必须是上架

**无需其他条件**：
- ❌ 不需要检查是否有进行中的兑换（兑换已完成）
- ❌ 不需要检查库存

**错误码**：`ALREADY_OFF_SHELF`

---

### R4.2 下架后状态
- ✅ **状态变更**：商品状态 → 下架
- ✅ **上架数量保留**：不清零，下次上架可参考
- ✅ **记录操作人**：更新 OperatorID
- ✅ **发布事件**：ProductUnshelved

**注意**：
- 已兑换的订单不受影响
- 用户无法新兑换该商品

---

## 5. 库存扣减规则

### R5.1 扣减触发时机
- ✅ **用户完成兑换支付**：金币已扣减，订单已确认
- ❌ **不在用户加购物车时扣减**：避免虚假库存锁定

**调用方**：
- Redemption Domain（兑换流程）
- 不对外开放 API（仅内部调用）

---

### R5.2 扣减前置条件
- ✅ **商品状态**：必须是上架状态
- ✅ **库存充足**：线上剩余 ≥ 兑换数量
- ✅ **未售罄**：AvailableQuantity > 0

**线上剩余计算**：
```
线上剩余 = 上架数量 - 已兑换数量
```

**错误码**：`PRODUCT_OFF_SHELF`, `INSUFFICIENT_STOCK`, `SOLD_OUT`

---

### R5.3 扣减原子性
- ✅ **使用行锁**：`SELECT ... FOR UPDATE` 防止并发问题
- ✅ **事务保证**：扣减库存和更新已兑换数在同一事务
- ✅ **重试机制**：失败时允许重试（幂等性）

**并发场景**：
- 100 个用户同时兑换同一商品
- 库存只有 10 个
- 只有前 10 个用户成功，其余返回库存不足

---

### R5.4 扣减后状态
- ✅ **已兑换数量 +N**：N 为兑换数量
- ✅ **线上剩余重新计算**：自动更新
- ✅ **收益累计**：Revenue += N × InitialCoins × 汇率
- ✅ **更新时间**：UpdatedAt 自动更新
- ✅ **发布事件**：InventoryDeducted

**自动售罄检测**：
```
如果 线上剩余 == 0，标记为售罄（可选功能）
```

---

## 6. 商品查询规则

### R6.1 列表查询
- ✅ **默认排序**：按创建时间倒序
- ✅ **筛选条件**：
  - 按状态筛选（上架/下架）
  - 按关键词搜索（商品名称）
  - 按操作人筛选
- ✅ **分页**：默认 20 条/页，最多 100 条/页

**业务逻辑**：
- 管理员看到所有商品
- 用户只看到上架商品（扩展功能）

---

### R6.2 详情查询
- ✅ **任意状态商品**：可以查询
- ✅ **返回完整信息**：包括库存、财务数据
- ✅ **权限控制**：管理员可见所有字段，用户仅可见部分字段（扩展功能）

---

## 7. 商品删除规则

### R7.1 删除限制
- ✅ **允许删除**：已下架且未兑换的商品
- ❌ **禁止删除**：
  - 上架状态的商品（必须先下架）
  - 已有兑换记录的商品（保留历史数据）

**建议**：
- 使用软删除（添加 deleted_at 字段）
- 或标记为"已归档"状态

**错误码**：`CANNOT_DELETE_ON_SHELF_PRODUCT`, `CANNOT_DELETE_REDEEMED_PRODUCT`

---

### R7.2 删除后清理
- ✅ **删除商品记录**：从 products 表删除
- ✅ **保留关联数据**：
  - 兑换记录保留（关联到已删除商品 ID）
  - 操作日志保留

---

## 8. 约束和不变量

### R8.1 数据库约束
```sql
-- 商品名称不为空
CONSTRAINT products_name_not_empty CHECK (LENGTH(TRIM(name)) > 0)

-- 库存非负
CONSTRAINT products_stock_non_negative CHECK (stock >= 0)

-- 初始金币为正
CONSTRAINT products_initial_coins_positive CHECK (initial_coins > 0)

-- 已兑换数不超过库存
CONSTRAINT products_redeemed_lte_stock CHECK (redeemed_count <= stock)

-- 上架数量不超过库存
CONSTRAINT products_listed_lte_stock CHECK (listed_quantity <= stock)

-- 线上剩余 = 上架数量 - 已兑换数量
CONSTRAINT products_available_calculation CHECK (available_quantity = listed_quantity - redeemed_count)
```

---

### R8.2 领域不变量
- ✅ **库存一致性**：`总库存 ≥ 已兑换数量 + 剩余库存`
- ✅ **状态一致性**：下架状态不能兑换
- ✅ **财务一致性**：收益 = 已兑换数量 × 单价

---

## 9. 扩展规则

### R9.1 商品分类（未实现）
- 商品可以归属到一个分类
- 分类支持多级（如：实物 > 玩具 > 益智玩具）

### R9.2 商品规格 SKU（未实现）
- 支持多规格商品（如：颜色、尺码）
- 每个 SKU 独立管理库存

### R9.3 定时上下架（未实现）
- 设置上架时间和下架时间
- 自动执行上下架操作

### R9.4 库存预警（未实现）
- 库存低于阈值时发送通知
- 支持自动补货

---

**版本**：1.0  
**最后更新**：2025-12-01

