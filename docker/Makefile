# ============================================
# Go-GenAI-Stack Docker Makefile
# ============================================
# ç®€åŒ– Docker æ“ä½œçš„ Makefile
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   make help           # æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
#   make up             # å¯åŠ¨æ‰€æœ‰æœåŠ¡
#   make down           # åœæ­¢æ‰€æœ‰æœåŠ¡
#   make logs           # æŸ¥çœ‹æ—¥å¿—
# ============================================

.PHONY: help up down restart logs ps build clean

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# ============================================
# åŸºç¡€å‘½ä»¤
# ============================================

## help: æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
help:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo " Go-GenAI-Stack Docker å‘½ä»¤"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "åŸºç¡€å‘½ä»¤:"
	@echo "  make up             - å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆBackend + DB + Redisï¼‰"
	@echo "  make down           - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make restart        - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  make ps             - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs           - æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—"
	@echo "  make logs-backend   - æŸ¥çœ‹åç«¯æ—¥å¿—"
	@echo "  make logs-db        - æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—"
	@echo ""
	@echo "æ„å»ºå’Œæ¸…ç†:"
	@echo "  make build          - æ„å»ºåç«¯é•œåƒ"
	@echo "  make rebuild        - é‡æ–°æ„å»ºåç«¯é•œåƒ"
	@echo "  make clean          - åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·"
	@echo ""
	@echo "é«˜çº§å‘½ä»¤:"
	@echo "  make up-full        - å¯åŠ¨å®Œæ•´æœåŠ¡ï¼ˆåŒ…å«å¯è§‚æµ‹æ€§ï¼‰"
	@echo "  make up-infra       - ä»…å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆDB + Redisï¼‰"
	@echo "  make up-debug       - å¯åŠ¨è°ƒè¯•ç¯å¢ƒ"
	@echo "  make shell          - è¿›å…¥åç«¯å®¹å™¨"
	@echo "  make db-shell       - è¿›å…¥æ•°æ®åº“å®¹å™¨"
	@echo ""
	@echo "ç”Ÿäº§ç¯å¢ƒ:"
	@echo "  make up-prod        - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  make down-prod      - åœæ­¢ç”Ÿäº§ç¯å¢ƒ"
	@echo ""

## up: å¯åŠ¨æ‰€æœ‰æœåŠ¡
up:
	@echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
	@docker-compose up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"
	@echo ""
	@make ps

## down: åœæ­¢æ‰€æœ‰æœåŠ¡
down:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

## restart: é‡å¯æ‰€æœ‰æœåŠ¡
restart:
	@echo "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡..."
	@docker-compose restart
	@echo "âœ… æœåŠ¡å·²é‡å¯"

## ps: æŸ¥çœ‹æœåŠ¡çŠ¶æ€
ps:
	@docker-compose ps

## logs: æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
logs:
	@docker-compose logs -f

## logs-backend: æŸ¥çœ‹åç«¯æ—¥å¿—
logs-backend:
	@docker-compose logs -f backend

## logs-db: æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
logs-db:
	@docker-compose logs -f postgres

# ============================================
# æ„å»ºå’Œæ¸…ç†
# ============================================

## build: æ„å»ºåç«¯é•œåƒ
build:
	@echo "ğŸ—ï¸  æ„å»ºåç«¯é•œåƒ..."
	@docker-compose build backend
	@echo "âœ… æ„å»ºå®Œæˆ"

## rebuild: é‡æ–°æ„å»ºåç«¯é•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
rebuild:
	@echo "ğŸ—ï¸  é‡æ–°æ„å»ºåç«¯é•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰..."
	@docker-compose build --no-cache backend
	@echo "âœ… æ„å»ºå®Œæˆ"

## clean: åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·
clean:
	@echo "âš ï¸  è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼"
	@read -p "ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ(y/N) " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "ğŸ—‘ï¸  æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·..."; \
		docker-compose down -v; \
		echo "âœ… æ¸…ç†å®Œæˆ"; \
	else \
		echo "âŒ å·²å–æ¶ˆ"; \
	fi

# ============================================
# é«˜çº§å‘½ä»¤
# ============================================

## up-full: å¯åŠ¨å®Œæ•´æœåŠ¡ï¼ˆåŒ…å«å¯è§‚æµ‹æ€§ï¼‰
up-full:
	@echo "ğŸš€ å¯åŠ¨å®Œæ•´æœåŠ¡ï¼ˆåŒ…å«å¯è§‚æµ‹æ€§ï¼‰..."
	@docker-compose --profile observability --profile tools up -d
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨"
	@echo ""
	@echo "è®¿é—®åœ°å€ï¼š"
	@echo "  - åç«¯ API:      http://localhost:8080/api"
	@echo "  - å¥åº·æ£€æŸ¥:      http://localhost:8080/health"
	@echo "  - Jaeger UI:     http://localhost:16686"
	@echo "  - Prometheus:    http://localhost:9090"
	@echo "  - Grafana:       http://localhost:3000"
	@echo "  - pgAdmin:       http://localhost:5050"

## up-infra: ä»…å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆDB + Redisï¼‰
up-infra:
	@echo "ğŸš€ å¯åŠ¨åŸºç¡€è®¾æ–½ï¼ˆDB + Redisï¼‰..."
	@docker-compose up -d --scale backend=0
	@echo "âœ… åŸºç¡€è®¾æ–½å·²å¯åŠ¨"

## up-debug: å¯åŠ¨è°ƒè¯•ç¯å¢ƒ
up-debug:
	@echo "ğŸš€ å¯åŠ¨è°ƒè¯•ç¯å¢ƒ..."
	@cd frontend-debug && docker compose up -d
	@echo "âœ… è°ƒè¯•ç¯å¢ƒå·²å¯åŠ¨"
	@echo ""
	@echo "è°ƒè¯•ç«¯å£ï¼š"
	@echo "  - API:    http://localhost:8080"
	@echo "  - Delve:  localhost:2345"

## shell: è¿›å…¥åç«¯å®¹å™¨
shell:
	@echo "ğŸš è¿›å…¥åç«¯å®¹å™¨..."
	@docker-compose exec backend sh

## db-shell: è¿›å…¥æ•°æ®åº“å®¹å™¨
db-shell:
	@echo "ğŸš è¿›å…¥æ•°æ®åº“å®¹å™¨..."
	@docker-compose exec postgres psql -U genai -d go_genai_stack

## redis-cli: è¿›å…¥ Redis CLI
redis-cli:
	@echo "ğŸš è¿›å…¥ Redis CLI..."
	@docker-compose exec redis redis-cli -a redis_password

# ============================================
# ç”Ÿäº§ç¯å¢ƒ
# ============================================

## up-prod: å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
up-prod:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨"
	@make ps-prod

## down-prod: åœæ­¢ç”Ÿäº§ç¯å¢ƒ
down-prod:
	@echo "ğŸ›‘ åœæ­¢ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
	@echo "âœ… ç”Ÿäº§ç¯å¢ƒå·²åœæ­¢"

## ps-prod: æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæœåŠ¡çŠ¶æ€
ps-prod:
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

## logs-prod: æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
logs-prod:
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# ============================================
# å¥åº·æ£€æŸ¥å’Œæµ‹è¯•
# ============================================

## health: æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
health:
	@echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@echo ""
	@echo "åç«¯æœåŠ¡:"
	@curl -s http://localhost:8080/health | jq . || echo "âŒ åç«¯æœåŠ¡ä¸å¯ç”¨"
	@echo ""
	@echo "PostgreSQL:"
	@docker-compose exec -T postgres pg_isready -U genai || echo "âŒ æ•°æ®åº“ä¸å¯ç”¨"
	@echo ""
	@echo "Redis:"
	@docker-compose exec -T redis redis-cli -a redis_password ping || echo "âŒ Redis ä¸å¯ç”¨"

## test: æµ‹è¯• API ç«¯ç‚¹
test:
	@echo "ğŸ§ª æµ‹è¯• API ç«¯ç‚¹..."
	@echo ""
	@echo "1. å¥åº·æ£€æŸ¥:"
	@curl -s http://localhost:8080/health | jq .
	@echo ""
	@echo "2. Metrics:"
	@curl -s http://localhost:8080/metrics | head -n 5
	@echo ""
	@echo "3. ä»»åŠ¡åˆ—è¡¨:"
	@curl -s http://localhost:8080/api/v1/tasks | jq .

# ============================================
# æ•°æ®å¤‡ä»½å’Œæ¢å¤
# ============================================

## backup-db: å¤‡ä»½æ•°æ®åº“
backup-db:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	@mkdir -p ./backups
	@docker-compose exec -T postgres pg_dump -U genai go_genai_stack > ./backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ: ./backups/backup_$$(date +%Y%m%d_%H%M%S).sql"

## restore-db: æ¢å¤æ•°æ®åº“ï¼ˆä½¿ç”¨æœ€æ–°å¤‡ä»½ï¼‰
restore-db:
	@echo "ğŸ“‚ æ¢å¤æ•°æ®åº“..."
	@LATEST_BACKUP=$$(ls -t ./backups/backup_*.sql | head -n1); \
	if [ -z "$$LATEST_BACKUP" ]; then \
		echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"; \
		exit 1; \
	fi; \
	echo "ä½¿ç”¨å¤‡ä»½æ–‡ä»¶: $$LATEST_BACKUP"; \
	cat $$LATEST_BACKUP | docker-compose exec -T postgres psql -U genai go_genai_stack; \
	echo "âœ… æ•°æ®åº“æ¢å¤å®Œæˆ"

# ============================================
# ç»´æŠ¤å‘½ä»¤
# ============================================

## prune: æ¸…ç† Docker ç³»ç»Ÿï¼ˆåˆ é™¤æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨ï¼‰
prune:
	@echo "ğŸ§¹ æ¸…ç† Docker ç³»ç»Ÿ..."
	@docker system prune -a
	@echo "âœ… æ¸…ç†å®Œæˆ"

## update: æ‹‰å–æœ€æ–°é•œåƒ
update:
	@echo "ğŸ”„ æ‹‰å–æœ€æ–°é•œåƒ..."
	@docker-compose pull
	@echo "âœ… é•œåƒæ›´æ–°å®Œæˆ"

## stats: æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
stats:
	@docker stats --no-stream go-genai-backend go-genai-postgres go-genai-redis

