# ============================================
# Go-GenAI-Stack 监控服务（独立部署）
# ============================================
# 统一可观测性栈，包括：
#   - Sentry: 前端错误追踪、性能监控、会话重放
#   - Jaeger: 后端分布式追踪
#   - Prometheus: 指标收集
#   - Grafana: 可视化
#
# 使用方式：
#   cd docker/monitoring
#   cp env.template .env
#   # 编辑 .env 设置密码
#   docker compose up -d
#   # 初始化 Sentry
#   docker compose exec sentry-web sentry upgrade --noinput
#   docker compose exec sentry-web sentry createuser
#
# 访问：
#   - Sentry: http://localhost:9000
#   - Jaeger UI: http://localhost:16686
#   - Prometheus: http://localhost:9090
#   - Grafana: http://localhost:3000
# ============================================

services:
  # ============================================
  # PostgreSQL for Sentry
  # ============================================
  sentry-postgres:
    image: postgres:14-alpine
    container_name: sentry-postgres
    restart: always
    environment:
      POSTGRES_USER: sentry
      POSTGRES_PASSWORD: ${SENTRY_POSTGRES_PASSWORD:?请设置 SENTRY_POSTGRES_PASSWORD}
      POSTGRES_DB: sentry
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - sentry-postgres-data:/var/lib/postgresql/data
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sentry -d sentry"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Redis for Sentry
  # ============================================
  sentry-redis:
    image: redis:7-alpine
    container_name: sentry-redis
    restart: always
    command: >
      redis-server
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
    volumes:
      - sentry-redis-data:/data
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================
  # Sentry Web Server
  # ============================================
  sentry-web:
    image: getsentry/sentry:24.1.0
    container_name: sentry-web
    restart: always
    depends_on:
      sentry-postgres:
        condition: service_healthy
      sentry-redis:
        condition: service_healthy
    environment:
      # Sentry 核心配置
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:?请设置 SENTRY_SECRET_KEY}
      
      # 数据库配置
      SENTRY_POSTGRES_HOST: sentry-postgres
      SENTRY_POSTGRES_PORT: 5432
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_POSTGRES_PASSWORD:?请设置 SENTRY_POSTGRES_PASSWORD}
      SENTRY_DB_NAME: sentry
      
      # Redis 配置
      SENTRY_REDIS_HOST: sentry-redis
      SENTRY_REDIS_PORT: 6379
      SENTRY_REDIS_DB: 0
      SENTRY_USE_REDIS_CLUSTER: 0
      
      # 文件存储配置
      SENTRY_FILESTORE_BACKEND: filesystem
      SENTRY_FILESTORE_OPTIONS: '{"location": "/var/lib/sentry/files"}'
      
      # Web 服务配置
      SENTRY_WEB_HOST: 0.0.0.0
      SENTRY_WEB_PORT: 9000
      SENTRY_WEB_OPTIONS: '{"workers": 3, "limit_request_line": 0, "limit_request_field_size": 0}'
      
      # URL 配置（用于邮件链接等）
      SENTRY_URL_PREFIX: ${SENTRY_URL_PREFIX:-http://localhost:9000}
      
      # 邮件配置（可选）
      SENTRY_EMAIL_BACKEND: ${SENTRY_EMAIL_BACKEND:-console}
      SENTRY_EMAIL_HOST: ${SENTRY_EMAIL_HOST:-}
      SENTRY_EMAIL_PORT: ${SENTRY_EMAIL_PORT:-587}
      SENTRY_EMAIL_USER: ${SENTRY_EMAIL_USER:-}
      SENTRY_EMAIL_PASSWORD: ${SENTRY_EMAIL_PASSWORD:-}
      SENTRY_EMAIL_USE_TLS: ${SENTRY_EMAIL_USE_TLS:-true}
      SENTRY_SERVER_EMAIL: ${SENTRY_SERVER_EMAIL:-sentry@localhost}
    ports:
      - "${SENTRY_PORT:-9000}:9000"
    volumes:
      - sentry-data:/var/lib/sentry/files
    networks:
      - sentry-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/0/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Sentry Worker (后台任务处理)
  # ============================================
  sentry-worker:
    image: getsentry/sentry:24.1.0
    container_name: sentry-worker
    restart: always
    depends_on:
      sentry-postgres:
        condition: service_healthy
      sentry-redis:
        condition: service_healthy
    command: run worker
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:?请设置 SENTRY_SECRET_KEY}
      SENTRY_POSTGRES_HOST: sentry-postgres
      SENTRY_POSTGRES_PORT: 5432
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_POSTGRES_PASSWORD:?请设置 SENTRY_POSTGRES_PASSWORD}
      SENTRY_DB_NAME: sentry
      SENTRY_REDIS_HOST: sentry-redis
      SENTRY_REDIS_PORT: 6379
      SENTRY_REDIS_DB: 0
      SENTRY_USE_REDIS_CLUSTER: 0
      SENTRY_FILESTORE_BACKEND: filesystem
      SENTRY_FILESTORE_OPTIONS: '{"location": "/var/lib/sentry/files"}'
    volumes:
      - sentry-data:/var/lib/sentry/files
    networks:
      - sentry-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # Sentry Cron (定时任务)
  # ============================================
  sentry-cron:
    image: getsentry/sentry:24.1.0
    container_name: sentry-cron
    restart: always
    depends_on:
      sentry-postgres:
        condition: service_healthy
      sentry-redis:
        condition: service_healthy
    command: run cron
    environment:
      SENTRY_SECRET_KEY: ${SENTRY_SECRET_KEY:?请设置 SENTRY_SECRET_KEY}
      SENTRY_POSTGRES_HOST: sentry-postgres
      SENTRY_POSTGRES_PORT: 5432
      SENTRY_DB_USER: sentry
      SENTRY_DB_PASSWORD: ${SENTRY_POSTGRES_PASSWORD:?请设置 SENTRY_POSTGRES_PASSWORD}
      SENTRY_DB_NAME: sentry
      SENTRY_REDIS_HOST: sentry-redis
      SENTRY_REDIS_PORT: 6379
      SENTRY_REDIS_DB: 0
      SENTRY_USE_REDIS_CLUSTER: 0
      SENTRY_FILESTORE_BACKEND: filesystem
      SENTRY_FILESTORE_OPTIONS: '{"location": "/var/lib/sentry/files"}'
    volumes:
      - sentry-data:/var/lib/sentry/files
    networks:
      - sentry-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================
  # Jaeger - 分布式追踪
  # ============================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: go-genai-stack-jaeger
    restart: always
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=info
      - SPAN_STORAGE_TYPE=badger
      - BADGER_EPHEMERAL=false
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "${JAEGER_UI_PORT:-16686}:16686"  # Jaeger UI
    volumes:
      - jaeger-data:/badger
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - monitoring-network
      - go-genai-stack-network

  # ============================================
  # Prometheus - 指标收集
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: go-genai-stack-prometheus
    restart: always
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - monitoring-network
      - go-genai-stack-network

  # ============================================
  # Grafana - 可视化
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: go-genai-stack-grafana
    restart: always
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:?请设置 GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_URL:-http://localhost:3000}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - monitoring-network
      - go-genai-stack-network

# ============================================
# 数据卷
# ============================================
volumes:
  # Sentry 数据卷
  sentry-postgres-data:
    driver: local
    name: sentry-postgres-data
  sentry-redis-data:
    driver: local
    name: sentry-redis-data
  sentry-data:
    driver: local
    name: sentry-data
  
  # 后端监控数据卷
  jaeger-data:
    driver: local
    name: go-genai-stack-jaeger-data
  prometheus-data:
    driver: local
    name: go-genai-stack-prometheus-data
  grafana-data:
    driver: local
    name: go-genai-stack-grafana-data

# ============================================
# 网络配置
# ============================================
networks:
  # Sentry 内部网络
  sentry-network:
    driver: bridge
    name: sentry-network
  
  # 监控服务内部网络
  monitoring-network:
    driver: bridge
    name: go-genai-stack-monitoring-network
  
  # 连接到业务服务网络（用于监控后端服务）
  go-genai-stack-network:
    driver: bridge
    name: go-genai-stack-network
    external: true

